{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="casino-body-wrapper">
    <div class="casino-header">
        <a href="{% url 'home' %}" class="back-button">
            <i class="fa-solid fa-chevron-left"></i>
        </a>
        <h1 class="sorteio-title">SORTEIO</h1>
        <div style="width: 40px;"></div> 
    </div>

    <div class="casino-main-content">
        <div class="text-center mb-4">
            <div class="balance-badge-premium">
                <i class="fas fa-ticket-alt"></i> 
                GIROS DISPONÍVEIS: <span id="roulette-spins">{{ roulette_spins }}</span>
            </div>
        </div>

        <div class="wheel-outer-container">
            <div class="wheel-pointer" id="main-pointer"></div>
            <div class="wheel-box">
                <div class="canvas-wrapper">
                    <canvas id="wheel-canvas" width="500" height="500"></canvas>
                </div>
                <div class="center-spin-anchor" id="spin-trigger">
                    <div class="center-btn-body">
                        <span>GIRAR</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="winners-card-glass">
            <h4 class="card-title-premium"><i class="fas fa-trophy"></i> ÚLTIMOS GANHADORES</h4>
            <div class="ticker-container-premium">
                <div class="winners-ticker" id="winners-feed">
                    {% for winner in recent_winners %}
                    <div class="winner-item-ticker">
                        <span>****{{ winner.user.phone_number|slice:"-4:" }}</span>
                        <span class="ticker-value">{{ winner.prize }} KZ</span>
                    </div>
                    {% endfor %}
                    {% for winner in recent_winners %}
                    <div class="winner-item-ticker">
                        <span>****{{ winner.user.phone_number|slice:"-4:" }}</span>
                        <span class="ticker-value">{{ winner.prize }} KZ</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="snd-spin" preload="auto" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
<audio id="snd-win" preload="auto" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

<style>
    :root {
        --casino-red: #d40000;
        --casino-black: #1a1a1a;
        --casino-gold: #ffd700;
        --win-green: #00ff88;
    }

    .casino-body-wrapper {
        min-height: 100vh;
        background: radial-gradient(circle at center, #2e0505 0%, #050000 100%);
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l30 30-30 30L0 30z' fill='%3C%231a0000' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        font-family: 'Poppins', sans-serif;
        color: white;
        padding: 20px;
        overflow: hidden;
    }

    .casino-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .back-button { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; border: 1px solid rgba(255,215,0,0.3); }
    .sorteio-title { font-weight: 900; font-size: 1.8rem; letter-spacing: 3px; background: linear-gradient(to bottom, #fff, #ffd700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
    .balance-badge-premium { background: rgba(0,0,0,0.6); padding: 10px 25px; border-radius: 50px; border: 2px solid var(--casino-gold); display: inline-block; box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); font-weight: bold; }

    .wheel-outer-container { position: relative; width: 100%; max-width: 340px; margin: 40px auto; }
    .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 40px; height: 50px; background: var(--casino-gold); clip-path: polygon(0% 0%, 100% 0%, 50% 100%); z-index: 100; filter: drop-shadow(0 0 10px gold); }
    
    .pointer-win-effect { animation: flash-pointer 0.5s infinite alternate; }
    @keyframes flash-pointer { from { filter: drop-shadow(0 0 5px gold); transform: translateX(-50%) scale(1); } to { filter: drop-shadow(0 0 30px gold); transform: translateX(-50%) scale(1.2); background: #fff; } }

    .wheel-box { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 50%; border: 12px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px #000; }
    .canvas-wrapper { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; }
    #wheel-canvas { width: 100%; height: 100%; transition: transform 6s cubic-bezier(0.15, 0, 0.15, 1); }

    .center-spin-anchor { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; background: var(--casino-gold); border-radius: 50%; z-index: 110; cursor: pointer; padding: 5px; box-shadow: 0 0 30px rgba(0,0,0,1); }
    .center-btn-body { width: 100%; height: 100%; background: radial-gradient(circle, #222, #000); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--casino-gold); font-weight: 900; border: 2px solid var(--casino-gold); }

    /* Estilo do Ticker que sobe */
    .winners-card-glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
    .card-title-premium { font-size: 0.85rem; color: var(--casino-gold); text-align: center; margin-bottom: 10px; }
    
    .ticker-container-premium { height: 80px; overflow: hidden; position: relative; }
    .winners-ticker { animation: scrollUp 10s linear infinite; }
    .winner-item-ticker { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; }
    .ticker-value { color: var(--win-green); font-weight: bold; }

    @keyframes scrollUp { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('wheel-canvas');
    const ctx = canvas.getContext('2d');
    const spinTrigger = document.getElementById('spin-trigger');
    const spinsDisplay = document.getElementById('roulette-spins');
    const pointer = document.getElementById('main-pointer');
    const sndSpin = document.getElementById('snd-spin');
    const sndWin = document.getElementById('snd-win');

    let prizes = {{ prizes_list|safe }};
    if (!prizes || prizes.length === 0) prizes = ["0", "500", "1000", "2500", "5000", "10000"];

    const segments = prizes.length;
    const arc = (2 * Math.PI) / segments;
    let currentRotation = 0;
    let isSpinning = false;

    // Função de desenho que aceita um índice para destacar
    function draw(winningIndex = null) {
        ctx.clearRect(0,0,500,500);
        for (let i = 0; i < segments; i++) {
            const angle = i * arc;
            
            // Se for o índice ganhador, usa Verde Neon, senão usa as cores padrão
            if (winningIndex !== null && i === winningIndex) {
                ctx.fillStyle = "#00ff88"; // Verde destaque
                ctx.shadowBlur = 20;
                ctx.shadowColor = "#00ff88";
            } else {
                ctx.fillStyle = (i % 2 === 0) ? "#d40000" : "#1a1a1a";
                ctx.shadowBlur = 0;
            }
            
            ctx.beginPath();
            ctx.moveTo(250, 250);
            ctx.arc(250, 250, 245, angle, angle + arc);
            ctx.lineTo(250, 250);
            ctx.fill();
            
            ctx.strokeStyle = (winningIndex !== null && i === winningIndex) ? "#fff" : "#ffd700";
            ctx.lineWidth = (winningIndex !== null && i === winningIndex) ? 5 : 2;
            ctx.stroke();

            ctx.save();
            ctx.translate(250, 250);
            ctx.rotate(angle + arc / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = (winningIndex !== null && i === winningIndex) ? "#000" : "#fff";
            ctx.font = "bold 26px Poppins";
            ctx.fillText(prizes[i] + " KZ", 230, 10);
            ctx.restore();
        }
    }

    function spin() {
        if (isSpinning || parseInt(spinsDisplay.innerText) <= 0) return;
        
        isSpinning = true;
        draw(null); // Reseta cores antes de girar
        pointer.classList.remove('pointer-win-effect');
        sndSpin.currentTime = 0;
        sndSpin.play().catch(()=>{});

        fetch('{% url "spin_roulette" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const prizeIndex = prizes.indexOf(data.prize.toString());
                const extraRounds = 360 * 10; 
                const segmentDeg = 360 / segments;
                const stopAngle = extraRounds + (360 - (prizeIndex * segmentDeg)) - (segmentDeg / 2) - 90;

                currentRotation += stopAngle;
                canvas.style.transform = `rotate(${currentRotation}deg)`;

                setTimeout(() => {
                    sndWin.play().catch(()=>{});
                    pointer.classList.add('pointer-win-effect');
                    
                    // DESTAQUE NO QUADRANTE:
                    draw(prizeIndex); 
                    
                    spinsDisplay.innerText = data.remaining_spins;
                    
                    setTimeout(() => {
                        pointer.classList.remove('pointer-win-effect');
                        isSpinning = false;
                        location.reload(); 
                    }, 5000);

                }, 6500);
            } else {
                alert(data.message);
                isSpinning = false;
            }
        });
    }

    draw(); // Desenho inicial
    spinTrigger.addEventListener('click', spin);
});
</script>
{% endblock %}
