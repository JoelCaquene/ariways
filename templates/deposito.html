{% extends "base.html" %}
{% load static %}

{% block title %}Airways - Depósito{% endblock %}

{% block content %}
<div class="deposit-wrapper">
    <div class="jackpay-header">
        <div class="logo-box">
            <i class="fa-solid fa-plane-departure"></i> <span>AIRWAYS PAY</span>
        </div>
    </div>

    <div class="stepper">
        <div class="step-item" id="step-dot-1">
            <div class="circle active">1</div>
            <span>Valor</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item" id="step-dot-2">
            <div class="circle">2</div>
            <span>Banco</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item" id="step-dot-3">
            <div class="circle">3</div>
            <span>Prova</span>
        </div>
    </div>

    {% if deposit_success %}
        <div class="success-screen glass-card">
            <div class="success-icon"><i class="fa-solid fa-circle-check"></i></div>
            <h2>Depósito Enviado!</h2>
            <p>Seu comprovativo foi recebido. O saldo será atualizado em instantes após a verificação (5 a 30 min).</p>
            <a href="{% url 'home' %}" class="btn-main glow-btn">VOLTAR AO INÍCIO</a>
        </div>
    {% else %}
        <form id="deposit-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="{{ form.amount.name }}" id="id_amount" value="">
            <input type="hidden" name="selected_bank" id="id_selected_bank" value="">

            <div id="step-1" class="step-content">
                <div class="balance-card glass-card">
                    <p><i class="fa-solid fa-wallet"></i> Saldo Atual</p>
                    <h3>Kz {{ user_balance|default:"0.00" }}</h3>
                </div>

                <div class="amount-section glass-card">
                    <label>Quanto deseja recarregar?</label>
                    <div class="input-wrapper">
                        <span class="currency">Kz</span>
                        <input type="number" id="manual-amount" placeholder="Digite o valor">
                    </div>

                    <p class="label-small">Sugestões de Nível</p>
                    <div class="grid-amounts">
                        {% for deposit_value in level_deposits_list %}
                            <button type="button" class="amount-btn" data-value="{{ deposit_value }}">{{ deposit_value }}</button>
                        {% endfor %}
                    </div>
                </div>

                <div class="info-rules glass-card">
                    <h4><i class="fa-solid fa-circle-exclamation"></i> Regras de Depósito</h4>
                    <ul>
                        <li><span class="badge">1</span> Use apenas os bancos listados.</li>
                        <li><span class="badge">2</span> Evite banimento: não envie provas falsas.</li>
                        <li><span class="badge">3</span> Suporte: <strong>08:30 às 20:00</strong>.</li>
                    </ul>
                </div>
                
                <button type="button" class="btn-main glow-btn" id="to-step-2" disabled>PRÓXIMO PASSO</button>
            </div>

            <div id="step-2" class="step-content" style="display: none;">
                <h4 class="step-title">Selecione o Banco de Destino</h4>
                <div class="bank-list">
                    {% for bank in platform_bank_details %}
                        <button type="button" class="bank-option-btn glass-card" data-bank-id="{{ forloop.counter }}">
                            <i class="fa-solid fa-building-columns"></i>
                            <span>{{ bank.bank_name }}</span>
                        </button>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main glow-btn" id="to-step-3" disabled>CONTINUAR</button>
            </div>

            <div id="step-3" class="step-content" style="display: none;">
                <div class="bank-details-wrapper">
                    {% for bank in platform_bank_details %}
                        <div id="details-{{ forloop.counter }}" class="bank-info-card glass-card" style="display: none;">
                            <div class="info-group">
                                <label>Titular da Conta</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.account_holder_name }}" readonly id="name-{{ forloop.counter }}">
                                    <button type="button" onclick="copyText('name-{{ forloop.counter }}')"><i class="fa-solid fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>IBAN para Transferência</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.IBAN }}" id="iban-{{ forloop.counter }}" readonly>
                                    <button type="button" onclick="copyText('iban-{{ forloop.counter }}')"><i class="fa-solid fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>Valor exato a transferir</label>
                                <div class="copy-input">
                                    <input type="text" class="display-final-amount" readonly id="val-{{ forloop.counter }}">
                                    <button type="button" onclick="copyText('val-{{ forloop.counter }}')"><i class="fa-solid fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main glow-btn" id="to-step-4">JÁ TRANSFERI O VALOR</button>
            </div>

            <div id="step-4" class="step-content" style="display: none;">
                <div class="upload-section glass-card">
                    <p class="upload-label">Carregar Comprovativo</p>
                    <div class="upload-box" onclick="document.getElementById('file-upload').click()">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <input type="file" name="{{ form.proof_of_payment.name }}" id="file-upload" hidden accept="image/*">
                        <p id="file-name">Toque para selecionar imagem</p>
                    </div>
                    
                    <div class="info-group" style="margin-top: 20px;">
                        <input type="text" name="payer_name" placeholder="Nome completo do ordenante" class="simple-input name-input" required>
                    </div>
                </div>

                <button type="submit" class="btn-main glow-btn submit-final">CONCLUIR DEPÓSITO</button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    :root {
        --primary-green: #00c853;
        --bright-grey: #e0e0e0;
        --glow-color: rgba(255, 255, 255, 0.3);
    }

    body {
        background: url("{% static 'images/background_airways.jpg' %}") center center fixed;
        background-size: cover;
        margin: 0;
        font-family: 'Poppins', sans-serif;
        color: white;
        padding-bottom: 50px;
    }

    .deposit-wrapper {
        max-width: 450px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    /* HEADER */
    .jackpay-header { text-align: center; margin-bottom: 25px; }
    .logo-box {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 12px 30px;
        border-radius: 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .logo-box i { color: var(--primary-green); font-size: 22px; }

    /* STEPPER */
    .stepper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
    .step-item { text-align: center; flex: 1; }
    .step-item span { font-size: 10px; font-weight: 600; text-transform: uppercase; margin-top: 5px; display: block; }
    .circle {
        width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
        display: flex; align-items: center; justify-content: center; margin: 0 auto;
        font-size: 14px; font-weight: bold; background: rgba(255,255,255,0.1);
    }
    .circle.active { border-color: var(--primary-green); background: var(--primary-green); color: black; }
    .circle.checked { background: var(--primary-green); border-color: var(--primary-green); color: black; }
    .step-line { flex: 1; height: 2px; background: rgba(255,255,255,0.2); margin-top: -15px; }

    /* GLASS CARD */
    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
    }

    .balance-card h3 { font-size: 24px; margin: 5px 0 0; color: var(--primary-green); }
    .balance-card p { margin: 0; font-size: 12px; opacity: 0.8; }

    .input-wrapper {
        display: flex; align-items: center; background: rgba(0,0,0,0.2);
        border-radius: 12px; padding: 12px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.1);
    }
    .input-wrapper input { background: transparent; border: none; outline: none; color: white; width: 100%; font-size: 18px; font-weight: 600; padding-left: 10px; }
    .currency { color: var(--primary-green); font-weight: 800; }

    .grid-amounts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .amount-btn {
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
        color: white; padding: 10px; border-radius: 12px; font-weight: 600; font-size: 12px; cursor: pointer;
    }
    .amount-btn.active { background: var(--primary-green); color: black; border-color: var(--primary-green); }

    .info-rules h4 { color: #ffeb3b; margin: 0 0 10px; font-size: 14px; }
    .info-rules ul { padding: 0; list-style: none; margin: 0; }
    .info-rules li { font-size: 11px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .badge { background: var(--primary-green); color: black; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 800; flex-shrink: 0; }

    /* BANCOS */
    .bank-option-btn { width: 100%; display: flex; align-items: center; gap: 15px; color: white; cursor: pointer; transition: 0.3s; padding: 15px 20px; text-align: left; }
    .bank-option-btn i { font-size: 20px; color: var(--primary-green); }
    .bank-option-btn.active { border-color: var(--primary-green); background: rgba(0, 200, 83, 0.2); }

    /* DETALHES DE CÓPIA */
    .info-group label { font-size: 11px; color: var(--bright-grey); margin-bottom: 5px; display: block; padding-left: 5px; }
    .copy-input { display: flex; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .copy-input input { background: transparent; border: none; padding: 12px; color: white; flex: 1; font-size: 13px; outline: none; }
    .copy-input button { background: var(--bright-grey); border: none; padding: 0 15px; cursor: pointer; color: #333; }

    /* UPLOAD E CAMPO DE NOME ATUALIZADO */
    .upload-box { border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; }
    .upload-box i { font-size: 40px; color: var(--primary-green); margin-bottom: 10px; }
    
    .name-input { 
        width: 100%; 
        box-sizing: border-box; 
        color: white; 
        padding: 15px; 
        outline: none; 
        font-size: 14px; 
        background: rgba(255,255,255,0.15); /* Cor sólida o suficiente para não ficar fusco/ilegível */
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 12px;
    }
    .name-input::placeholder { color: rgba(255,255,255,0.7); }

    /* BOTÃO */
    .btn-main {
        width: 100%; border: none; padding: 16px; border-radius: 15px; font-weight: 800; font-size: 14px; cursor: pointer; margin-top: 10px; transition: 0.3s;
    }
    .glow-btn {
        background: var(--bright-grey); color: #222;
        box-shadow: 0 0 15px var(--glow-color); border: 1px solid #fff;
    }
    .btn-main:disabled { opacity: 0.4; cursor: not-allowed; }
    .submit-final { background: var(--primary-green); color: black; border: none; box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4); }

    /* SUCESSO */
    .success-icon { font-size: 60px; color: var(--primary-green); margin-bottom: 15px; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentStep = 1;
        const amountBtns = document.querySelectorAll('.amount-btn');
        const bankBtns = document.querySelectorAll('.bank-option-btn');
        const next1 = document.getElementById('to-step-2');
        const next2 = document.getElementById('to-step-3');
        const manualInput = document.getElementById('manual-amount');
        const amountInput = document.getElementById('id_amount');
        const bankInput = document.getElementById('id_selected_bank');

        amountBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                amountBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                manualInput.value = btn.dataset.value;
                updateAmount(btn.dataset.value);
            });
        });

        manualInput.addEventListener('input', (e) => {
            amountBtns.forEach(b => b.classList.remove('active'));
            updateAmount(e.target.value);
        });

        function updateAmount(val) {
            if (val > 0) {
                amountInput.value = val;
                document.querySelectorAll('.display-final-amount').forEach(el => el.value = "Kz " + val + ".00");
                next1.disabled = false;
            } else {
                next1.disabled = true;
            }
        }

        next1.addEventListener('click', () => { goToStep(2); updateStepper(2); });

        bankBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                bankBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                bankInput.value = btn.dataset.bankId;
                next2.disabled = false;
            });
        });

        next2.addEventListener('click', () => {
            const bankId = bankInput.value;
            document.querySelectorAll('.bank-info-card').forEach(card => card.style.display = 'none');
            document.getElementById(`details-${bankId}`).style.display = 'block';
            goToStep(3);
            updateStepper(2); 
        });

        document.getElementById('to-step-4').addEventListener('click', () => {
            goToStep(4);
            updateStepper(3);
        });

        document.getElementById('file-upload').addEventListener('change', function() {
            document.getElementById('file-name').innerText = this.files[0] ? this.files[0].name : "Toque para selecionar imagem";
            document.getElementById('file-name').style.color = "#00c853";
        });

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            document.getElementById(`step-${step}`).style.display = 'block';
            window.scrollTo(0,0);
        }

        function updateStepper(activeStep) {
            const dots = document.querySelectorAll('.step-item .circle');
            dots.forEach((dot, idx) => {
                dot.classList.remove('active', 'checked');
                if (idx + 1 < activeStep) {
                    dot.classList.add('checked');
                    dot.innerHTML = '<i class="fa-solid fa-check"></i>';
                } else if (idx + 1 === activeStep) {
                    dot.classList.add('active');
                    dot.innerHTML = activeStep;
                }
            });
        }
    });

    function copyText(id) {
        const copyText = document.getElementById(id);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        const btn = event.currentTarget;
        const icon = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
        setTimeout(() => { btn.innerHTML = icon; }, 1500);
    }
</script>
{% endblock %}
